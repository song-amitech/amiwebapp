<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AMITECH 社員検索</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
      max-width: 760px;
      margin: 40px auto;
      padding: 0 16px;
    }
    h1 { font-size: 22px; margin-bottom: 16px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    input {
      flex: 1;
      min-width: 220px;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    button {
      padding: 10px 14px;
      border: 1px solid #ccc;
      background: #fafafa;
      border-radius: 8px;
      cursor: pointer;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }

    .meta {
      margin-top: 10px;
      font-size: 13px;
      color: #666;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    .muted { color: #666; }
    .error { color: #b00020; white-space: pre-wrap; }

    tfoot td {
      font-size: 13px;
      color: #666;
    }
  </style>
</head>

<body>
  <h1>AMITECH 社員検索</h1>

  <div class="row">
    <input id="q" placeholder="社員番号・氏名・部署で検索" />
    <button id="btn">検索</button>
    <button id="clear">クリア</button>
  </div>

  <div class="meta">
    <div id="status">待機中</div>
    <div id="count"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>社員番号</th>
        <th>氏名</th>
        <th>部署</th>
        <th>Email</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="4" class="muted">読み込み中…</td></tr>
    </tbody>
    <tfoot>
      <tr>
        <td colspan="4">※ データは App Service の API から取得します</td>
      </tr>
    </tfoot>
  </table>

<script>
/* ===== 設定 ===== */
// ★ 必ず App Service の API ドメインを書く（相対パス禁止）
const API_BASE = "https://amitechaps01-fnffcgc6chdybwaz.japanwest-01.azurewebsites.net";

/* ===== DOM ===== */
const tbody = document.getElementById("tbody");
const q = document.getElementById("q");
const btn = document.getElementById("btn");
const clearBtn = document.getElementById("clear");
const statusEl = document.getElementById("status");
const countEl = document.getElementById("count");

/* ===== 共通UI ===== */
function showMessage(msg, isError = false) {
  tbody.innerHTML =
    `<tr><td colspan="4" class="${isError ? "error" : "muted"}">${msg}</td></tr>`;
}

function setLoading(on) {
  btn.disabled = on;
  clearBtn.disabled = on;
  q.disabled = on;
  statusEl.textContent = on ? "検索中…" : "待機中";
}

/* ===== 表示 ===== */
function renderRows(data) {
  tbody.innerHTML = data.map(r => `
    <tr>
      <td>${r.employeeNo ?? "-"}</td>
      <td>${r.name ?? "-"}</td>
      <td>${r.department ?? "-"}</td>
      <td>${r.email ?? "-"}</td>
    </tr>
  `).join("");
}

/* ===== API ===== */
async function search(keyword = "") {
  setLoading(true);
  countEl.textContent = "";
  showMessage("読み込み中…");

  const url = keyword
    ? `${API_BASE}/api/employees?keyword=${encodeURIComponent(keyword)}`
    : `${API_BASE}/api/employees`;

  try {
    const res = await fetch(url, {
      headers: { "Accept": "application/json" },
      cache: "no-store"
    });

    const ct = res.headers.get("content-type") || "";

    // ★ JSON以外は即エラー表示（HTML誤返却対策）
    if (!ct.includes("application/json")) {
      const text = await res.text();
      showMessage(
        `JSONではありません\nURL: ${url}\nStatus: ${res.status}\nContent-Type: ${ct}\n---\n${text.substring(0,200)}`,
        true
      );
      return;
    }

    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      showMessage("データがありません");
      countEl.textContent = "0件";
      return;
    }

    renderRows(data);
    countEl.textContent = `${data.length}件`;
    statusEl.textContent = keyword ? `「${keyword}」で検索` : "全件表示";

  } catch (e) {
    showMessage(`通信エラー: ${e.message}`, true);
  } finally {
    setLoading(false);
  }
}

/* ===== イベント ===== */
btn.addEventListener("click", () => search(q.value.trim()));
clearBtn.addEventListener("click", () => { q.value = ""; q.focus(); search(""); });
q.addEventListener("keydown", e => { if (e.key === "Enter") search(q.value.trim()); });

/* 初回ロード */
window.addEventListener("DOMContentLoaded", () => {
  q.focus();
  // search(""); を削除し、代わりにメッセージを表示する
  showMessage("検索キーワードを入力してください");
});
</script>

</body>
</html>
